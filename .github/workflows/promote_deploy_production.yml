name: Promote to Production
on:
  workflow_dispatch:
    inputs:
      model_version:
        description: "Model version to promote"
        required: true

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install MLflow
        run: pip install mlflow==2.14.3
      - name: Promote model version in MLflow registry
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.DAGSHUB_MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
          MODEL_NAME: churn-model
          MODEL_VERSION: ${{ github.event.inputs.model_version }}
        run: |
          python - << 'PY'
          import os, mlflow
          from mlflow.tracking import MlflowClient
          
          mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])
          token = os.environ["MLFLOW_TRACKING_TOKEN"]
          os.environ["MLFLOW_TRACKING_USERNAME"] = token
          os.environ["MLFLOW_TRACKING_PASSWORD"] = token
          
          client = MlflowClient()
          name = os.environ["MODEL_NAME"]
          version = os.environ["MODEL_VERSION"]
          
          # Transition vers Production et archivage des anciennes versions
          client.transition_model_version_stage(
              name=name,
              version=version,
              stage="Production",
              archive_existing_versions=True
          )
          print(f"Promoted {name} v{version} to Production")
          PY