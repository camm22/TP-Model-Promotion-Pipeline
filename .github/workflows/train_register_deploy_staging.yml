name: Candidate to Staging

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "ml/**"
      - ".github/workflows/train_register_deploy_staging.yml"

jobs:
  train_register:
    runs-on: ubuntu-latest
    outputs:
      result_json: ${{ steps.train.outputs.result_json }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ML dependencies
        run: pip install -r ml/requirements.txt

      - name: Train + Register model in MLflow
        id: train
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.DAGSHUB_MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
          MODEL_NAME: churn-model
          DATA_VERSION: "dvc:v1"
        run: |
          python ml/train_and_register.py | tee train_out.json
          echo "result_json=$(cat train_out.json)" >> "$GITHUB_OUTPUT"

      - name: Apply Quality Gate
        env:
          ACCURACY_THRESHOLD: "0.85"
        run: |
          echo '${{ steps.train.outputs.result_json }}' | python ml/evaluate.py

  deploy_staging:
    needs: train_register
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Login to DockerHub
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

      - name: Build & Push Backend Image (Staging)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          docker build -t "$DOCKERHUB_USERNAME/churn-backend:staging" backend
          docker push "$DOCKERHUB_USERNAME/churn-backend:staging"

      - name: Deploy to Staging (placeholder)
        run: |
          echo "Here you would SSH to staging server and run docker-compose pull/up"

  staging_smoke_test:
    needs: deploy_staging
    runs-on: ubuntu-latest

    steps:
      - name: Smoke Test Placeholder
        run: |
          echo "In real setup: curl staging /health and /predict"
